var action="block",ngrams=!0,tags="p,a,h1,h2,h3,h4,h5,h6,li,span,em,strong,code,samp,kbd,var,blockquote,label,th,td,output";function getNgrams(a,b){for(var c=[],k=function(c){for(var e=[],d=0;d<b;d++)e.push(a[c+b+(d-b)]);return e},d=a.length-b+1,e=0;e<d;e++)c.push(k(e));return c}function getMatches(a){var b={},c;for(c in permaLexicon)if(permaLexicon.hasOwnProperty(c)){var k=[],d=permaLexicon[c],e;for(e in d)d.hasOwnProperty(e)&&-1<a.indexOf(e)&&k.push(Number(d[e]));b[c]=k}return b}
function calcLex(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&(b+=Number(a[c]));return b}
function main(){var a={action:action,block:!1,elements:0,filtered:0},b=document.querySelectorAll(tags),c=b.length;if(0<c){a=0;for(var k=[],d=[],e=[],p=[],q=[],r=[],t=[],u=[],v=[],w=[],l=0;l<c;l++){var g=b[l].textContent.match(permaReg);if(g){if(ngrams){var h=getNgrams(g,2),n=getNgrams(g,3);g=g.concat(h,n)}var f=getMatches(g);if(f){g=calcLex(f.POS_P);h=calcLex(f.POS_E);n=calcLex(f.POS_R);var x=calcLex(f.POS_M),y=calcLex(f.POS_A),z=calcLex(f.NEG_P),A=calcLex(f.NEG_E),B=calcLex(f.NEG_R),C=calcLex(f.NEG_M);
f=calcLex(f.NEG_A);k.push(g);d.push(h);e.push(n);p.push(x);q.push(y);r.push(z);t.push(A);u.push(B);v.push(C);w.push(f);var m=0;g<z&&m++;h<A&&m++;n<B&&m++;x<C&&m++;y<f&&m++;if(3<=m&&(a++,"redact"===action&&b[l].classList))for(b[l].classList.add("pp_redacted"),g=b[l].children,h=0;h<g.length;h++)g[h].classList&&g[h].classList.add("pp_redacted")}}}b=function(a){return a.reduce(function(a,b){return a+b})/a.length};a={elements:c,filtered:a,perma:{POS_P:b(k),POS_E:b(d),POS_R:b(e),POS_M:b(p),POS_A:b(q),NEG_P:b(r),
NEG_E:b(t),NEG_R:b(u),NEG_M:b(v),NEG_A:b(w)}};c=0;a.perma.POS_P>a.perma.NEG_P&&c++;a.perma.POS_E>a.perma.NEG_E&&c++;a.perma.POS_R>a.perma.NEG_R&&c++;a.perma.POS_M>a.perma.NEG_M&&c++;a.perma.POS_A>a.perma.NEG_A&&c++;"block"===action&&3>=c&&(a.block=!0);a.rate=c}return a}
permaLexicon?chrome.storage.sync.get({action:"block",ngrams:!0,tags:"p,a,h1,h2,h3,h4,h5,h6,li,span,em,strong,code,samp,kbd,var,blockquote,label,th,td,output"},function(a){action=a.action;ngrams=a.ngrams;tags=a.tags;if(0<tags.length){var b=main();chrome.runtime.sendMessage({data:b});chrome.runtime.onMessage.addListener(function(a,k,d){"popup"===a.from&&"data"===a.subject?d(b):console.error("Unrecognised message: ",a)})}else console.log("PERMA Police: no elements selected to scan in options.")}):console.error("PERMA lexicon is missing!");