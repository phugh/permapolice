var action="block",ngrams=!0,tags="p,a,h1,h2,h3,h4,h5,h6,li,span,em,strong,code,samp,kbd,var,blockquote,label,th,td,output",tolerance=3;function getNgrams(a,b){for(var c=[],k=function(c){for(var g=[],e=0;e<b;e++)g.push(a[c+b+(e-b)]);return g},g=a.length-b+1,e=0;e<g;e++)c.push(k(e));return c}
function getMatches(a){var b={},c;for(c in permaLexicon)if(permaLexicon.hasOwnProperty(c)){for(var k=[],g=permaLexicon[c],e=Object.keys(g),p=e.length;p--;){var q=e[p];-1<a.indexOf(q)&&k.push(g[q])}b[c]=k}return b}function calcLex(a){var b=0,c;for(c in a)a.hasOwnProperty(c)&&(b+=a[c]);return b}
function main(){var a={action:action,block:!1,elements:0,filtered:0},b=document.querySelectorAll(tags),c=b.length;if(0<c){a=0;for(var k=[],g=[],e=[],p=[],q=[],r=[],t=[],u=[],v=[],w=[],l=0;l<c;l++){var f=b[l].textContent.match(permaReg);if(f){if(ngrams){var h=getNgrams(f,2),m=getNgrams(f,3);f=f.concat(h,m)}var d=getMatches(f);if(d){f=calcLex(d.POS_P);h=calcLex(d.POS_E);m=calcLex(d.POS_R);var x=calcLex(d.POS_M),y=calcLex(d.POS_A),z=calcLex(d.NEG_P),A=calcLex(d.NEG_E),B=calcLex(d.NEG_R),C=calcLex(d.NEG_M);
d=calcLex(d.NEG_A);k.push(f);g.push(h);e.push(m);p.push(x);q.push(y);r.push(z);t.push(A);u.push(B);v.push(C);w.push(d);var n=0;f<z&&n++;h<A&&n++;m<B&&n++;x<C&&n++;y<d&&n++;if(3<=n&&(a++,"redact"===action&&b[l].classList))for(b[l].classList.add("pp_redacted"),f=b[l].children,h=0,m=f.length;h<m;h++)f[h].classList&&f[h].classList.add("pp_redacted")}}}b=function(a){return a.reduce(function(a,b){return a+b})/a.length};a={elements:c,filtered:a,perma:{POS_P:b(k),POS_E:b(g),POS_R:b(e),POS_M:b(p),POS_A:b(q),
NEG_P:b(r),NEG_E:b(t),NEG_R:b(u),NEG_M:b(v),NEG_A:b(w)}};c=0;a.perma.POS_P>a.perma.NEG_P&&c++;a.perma.POS_E>a.perma.NEG_E&&c++;a.perma.POS_R>a.perma.NEG_R&&c++;a.perma.POS_M>a.perma.NEG_M&&c++;a.perma.POS_A>a.perma.NEG_A&&c++;"block"===action&&c<=tolerance&&(a.block=!0);a.rate=c}return a}
if(permaLexicon)chrome.storage.sync.get({action:action,ngrams:ngrams,tags:tags,tolerance:tolerance},function(a){action=a.action;ngrams=a.ngrams;tags=a.tags;tolerance=a.tolerance;if(0<tags.length){var b=main();chrome.runtime.sendMessage({data:b});chrome.runtime.onMessage.addListener(function(a,k,g){"popup"===a.from&&"data"===a.subject?g(b):console.error("Unrecognised message: ",a)})}else console.log("PERMA Police: no elements selected to scan in options.")});else throw Error("PERMA lexicon is missing!");